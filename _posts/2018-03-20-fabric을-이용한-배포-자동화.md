---
layout: post
title: "fabric을 이용한 AWS EC2 인스턴스 배포 자동화"
tags: [python,fabric]
comments: true
---

Amazon EC2는 고유의 메타데이터를 태그의 형태로 각 리소스에 배정하여 인스턴스, 이미지 및 기타 Amazon EC2 리소스를 쉽게 관리할 수 있다. fabric과 boto3 라이브러리를 이용하고 EC2 리소스의 태그를 사용하여 인스턴스를 자동으로 배포하는 방법을 공부해 보았다.

# 1. Fabric
python의 패키지 중 shell 명령어를 실행할 수 있게 해주는 패키지가 fabric이다.


#### 1-1. Fabric 설치

```
$ pip3 install fabric

# 혹은
$ python -m pip install fabric
```

#### 1-2. Fabric 파일 실행 방법
Fabric은 기본적으로 fabfile.py라는 파일을 실행하므로, 파일 이름은 fabfile.py로 한다

```
 $ fab [FUNCTION_NAME]:[PARAMETER]=[VALUE]
```

<br/><br/>

# 2. Boto3
Boto3를 사용하면 python 애플리케이션, 라이브러리 또는 스크립트를 Amazon S3, Amazon EC2 등 AWS 서비스와 쉽게 통합할 수 있다.


#### 2-1. Boto3 설치

```
$ pip3 install boto3

# 혹은
$ python -m pip install boto3
```

<br/>

# 3. 설정 방법
- /home/users/.ssh 디렉토리 하위에 있는 AWS 비공개 키 파일(.pem)이 있는지 확인한다. 해당 경로는 이후에 env.key_filename 변수에 할당된다.
- EC2 인스턴스의 private_ip는 고정된 주소가 아니라 유동적인 IP 주소이다. EC2 인스턴스를 STOP 한 후에 재시작 하게 되면 다른 IP 주소로 바뀌게 된다. 이로 인해 코드 상에서 인스턴스의 태그 image_id로 private_ip 주소를 가져오는 작업이 필요하다

```
def get_ec2_ip(){
  ec2 = boto3.resource('ec2');
  instances = ec2.instances.filter(
    Filters=[{ 'Name' : 'image-id', 'Values' : ['ami-145af67a',]},]
  )

  for instance in instances:
    ips.append(instance.private_ip_address)

return ips
}
```
